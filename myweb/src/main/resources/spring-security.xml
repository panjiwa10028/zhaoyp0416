<?xml version="1.0" encoding="UTF-8"?>
<beans:beans xmlns="http://www.springframework.org/schema/security"
	xmlns:beans="http://www.springframework.org/schema/beans" xmlns:jee="http://www.springframework.org/schema/jee"
	xmlns:tx="http://www.springframework.org/schema/tx" xmlns:context="http://www.springframework.org/schema/context"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.5.xsd
                        http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-2.5.xsd
                        http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-2.5.xsd
                        http://www.springframework.org/schema/jee http://www.springframework.org/schema/jee/spring-jee-2.5.xsd                        
                        http://www.springframework.org/schema/security http://www.springframework.org/schema/security/spring-security-2.0.4.xsd"
	default-autowire="byName" default-lazy-init="true">


	<http auto-config="false" entry-point-ref="authenticationEntryPoint">
		<intercept-url pattern="/login.action" access="IS_AUTHENTICATED_ANONYMOUSLY" />
		<anonymous />
		<http-basic />
		<!--
			两个配置都只允许用户登录一次，exception-if-maximum-exceeded 默认为false，此值表示：
			用户第二次登录时，前一次的登录信息都被清空。当exception-if-maximum-exceeded="true"时系统会拒
			绝第二次登录。
		-->
		<concurrent-session-control max-sessions="1"
			exception-if-maximum-exceeded="true" />
	</http>

	<authentication-provider user-service-ref="userDetailsService">
		<password-encoder hash="md5">
			<salt-source user-property="username" />
		</password-encoder>
	</authentication-provider>

	<authentication-manager alias="authenticationManager" />

	<beans:bean id="accessDecisionManager"
		class="org.springframework.security.vote.AffirmativeBased">
		<beans:property name="allowIfAllAbstainDecisions"
			value="false" />
		<beans:property name="decisionVoters">
			<beans:list>
				<beans:bean class="org.springframework.security.vote.RoleVoter">
					<beans:property name="rolePrefix" value="PER_" />
				</beans:bean>
				<beans:bean class="org.springframework.security.vote.AuthenticatedVoter" />
			</beans:list>
		</beans:property>
	</beans:bean>

	<beans:bean id="resourceSecurityInterceptor"
		class="org.springframework.security.intercept.web.FilterSecurityInterceptor">
		<beans:property name="authenticationManager" ref="authenticationManager" />
		<beans:property name="accessDecisionManager" ref="accessDecisionManager" />
		<beans:property name="objectDefinitionSource"
			ref="dbFilterInvocationDefinitionSource" />
		<beans:property name="observeOncePerRequest" value="false" />
		<custom-filter after="LAST" />
	</beans:bean>

	
	<beans:bean id="rememberMeServices"
		class="org.springframework.security.ui.rememberme.TokenBasedRememberMeServices">
		<beans:property name="key"
			value="e37f4b31-0c45-11dd-bd0b-0800200c9a66" />
		<beans:property name="userDetailsService" ref="userDetailsService" />
	</beans:bean>

	<beans:bean id="authenticationProcessingFilter"
		class="com.yanpeng.ssweb.filter.MyLoginFilter">
		<custom-filter position="AUTHENTICATION_PROCESSING_FILTER" />
		<beans:property name="authenticationManager" ref="authenticationManager" />
		<beans:property name="authenticationFailureUrl" value="/login.action?error=1" />
		<beans:property name="defaultTargetUrl" value="/admin/main.action" />
		<beans:property name="rememberMeServices" ref="rememberMeServices" />
		<beans:property name="exceptionMappings">
			<beans:props>
			<beans:prop
					key="org.springframework.security.LockedException">/login.action?error=7</beans:prop>
					<beans:prop
					key="org.springframework.security.DisabledException">/login.action?error=6</beans:prop>
					<beans:prop
					key="org.springframework.security.AccountExpiredException">/login.action?error=5</beans:prop>
				<beans:prop
					key="com.yanpeng.ssweb.exceptions.AuthenticationCodeException">/login.action?error=4</beans:prop>
				<beans:prop
					key="org.springframework.security.concurrent.ConcurrentLoginException">/login.action?error=3</beans:prop>
					<beans:prop
					key="org.springframework.security.BadCredentialsException">/login.action?error=2</beans:prop>
			</beans:props>
		</beans:property>

	</beans:bean>
	<beans:bean id="myLogoutFilter" class="com.yanpeng.ssweb.filter.MyLogoutFilter">
		<custom-filter position="LOGOUT_FILTER" />
		<beans:constructor-arg value="/" />
		<beans:constructor-arg>
			<beans:list>
				<beans:bean
					class="org.springframework.security.ui.logout.SecurityContextLogoutHandler" />
			</beans:list>
		</beans:constructor-arg>
	</beans:bean>

	<beans:bean id="authenticationEntryPoint"
		class="org.springframework.security.ui.webapp.AuthenticationProcessingFilterEntryPoint">
		<beans:property name="loginFormUrl" value="/login.action" />
	</beans:bean>

	<beans:bean id="dbFilterInvocationDefinitionSource"
		class="com.yanpeng.ssweb.service.security.resource.DbFilterInvocationDefinitionSource" />


	<beans:bean id="userDetailsService"
		class="com.yanpeng.ssweb.service.security.UserDetailServiceImpl" />




</beans:beans>